-- Comprehensive test scenarios for DAO Maker

module Test where

import Daml.Script
import GovernanceToken
import Staking
import Governance
import DAOSetup
import DA.Time
import DA.Date

-- Test: Complete DAO lifecycle
testCompleteDAOLifecycle : Script ()
testCompleteDAOLifecycle = script do
  -- Setup parties
  daoParty <- allocateParty "DAO"
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  charlie <- allocateParty "Charlie"
  
  -- Initialize DAO
  configCid <- submit daoParty do
    createCmd DAOConfig with
      dao = daoParty
      daoName = "TestDAO"
      tokenSymbol = "TDAO"
      initialTreasuryBalance = 10000.0
      defaultQuorum = 100.0
      defaultVotingPeriodDays = 7
      members = [alice, bob, charlie]
      defaultMaintenanceMargin = 1.5
      defaultLiquidationPenalty = 0.1
  
  (adminCid, poolCid, treasuryCid) <- submit daoParty do
    exerciseCmd configCid InitializeDAO
  
  -- Issue tokens to members
  aliceTokenCid <- submit daoParty do
    exerciseCmd adminCid IssueTokens with
      recipient = alice
      amount = 1000.0
  
  bobTokenCid <- submit daoParty do
    exerciseCmd adminCid IssueTokens with
      recipient = bob
      amount = 800.0
  
  charlieTokenCid <- submit daoParty do
    exerciseCmd adminCid IssueTokens with
      recipient = charlie
      amount = 500.0
  
  -- Members stake their tokens
  aliceStakeCid <- submit alice do
    exerciseCmd poolCid Stake with
      staker = alice
      tokenCid = aliceTokenCid
  
  bobStakeCid <- submit bob do
    exerciseCmd poolCid Stake with
      staker = bob
      tokenCid = bobTokenCid
  
  charlieStakeCid <- submit charlie do
    exerciseCmd poolCid Stake with
      staker = charlie
      tokenCid = charlieTokenCid
  
  -- Alice creates a proposal to transfer funds
  proposalReqCid <- submit alice do
    createCmd ProposalRequest with
      dao = daoParty
      proposer = alice
      proposalId = "PROP-001"
      title = "Fund Community Event"
      description = "Transfer 500 TDAO to Alice for organizing a community event"
      payload = "transfer:alice:500"
      action = TransferFunds with recipient = alice; amount = 500.0
      quorumRequired = 100.0
      votingPeriodDays = 7
      treasuryCid = Some treasuryCid
      eligibleVoters = [alice, bob, charlie]
  
  -- DAO approves the proposal
  proposalCid <- submit daoParty do
    exerciseCmd proposalReqCid ApproveProposal
  
  -- Members vote
  proposalCid <- submit alice do
    exerciseCmd proposalCid CastVote with
      voter = alice
      stakeCid = aliceStakeCid
      inFavor = True
  
  proposalCid <- submit bob do
    exerciseCmd proposalCid CastVote with
      voter = bob
      stakeCid = bobStakeCid
      inFavor = True
  
  proposalCid <- submit charlie do
    exerciseCmd proposalCid CastVote with
      voter = charlie
      stakeCid = charlieStakeCid
      inFavor = False
  
  -- Wait for voting period (simulated by passing time)
  setTime (time (date 2025 Dec 20) 0 0 0)
  
  -- Finalize proposal
  proposalCid <- submit daoParty do
    exerciseCmd proposalCid FinalizeProposal with
      currentTime = time (date 2025 Dec 20) 0 0 0
  
  -- Execute proposal
  (finalProposalCid, newTreasuryCid) <- submit daoParty do
    exerciseCmd proposalCid ExecuteProposal with
      currentTime = time (date 2025 Dec 20) 0 0 0
  
  return ()

-- Test: Token operations
testTokenOperations : Script ()
testTokenOperations = script do
  dao <- allocateParty "DAO"
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  
  -- Issue token
  tokenCid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = alice
      amount = 1000.0
      symbol = "TEST"
  
  -- Split token
  (token1Cid, token2Cid) <- submit alice do
    exerciseCmd tokenCid Split with
      splitAmount = 300.0
  
  -- Transfer one part to Bob
  bobTokenCid <- submit alice do
    exerciseCmd token1Cid Transfer with
      newOwner = bob
  
  -- Issue another token to alice
  token3Cid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = alice
      amount = 200.0
      symbol = "TEST"
  
  -- Merge alice's tokens
  mergedCid <- submit alice do
    exerciseCmd token2Cid Merge with
      otherCid = token3Cid
  
  return ()

-- Test: Staking operations
testStakingOperations : Script ()
testStakingOperations = script do
  dao <- allocateParty "DAO"
  alice <- allocateParty "Alice"
  
  -- Setup (with alice as observer)
  poolCid <- submit dao do
    createCmd StakingPool with
      dao = dao
      tokenSymbol = "TEST"
      totalStaked = 0.0
      stakers = [alice]
  
  tokenCid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = alice
      amount = 1000.0
      symbol = "TEST"
  
  -- Stake
  stakeCid <- submit alice do
    exerciseCmd poolCid Stake with
      staker = alice
      tokenCid = tokenCid
  
  -- Increase stake
  token2Cid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = alice
      amount = 500.0
      symbol = "TEST"
  
  stakeCid <- submit alice do
    exerciseCmd stakeCid IncreaseStake with
      tokenCid = token2Cid
  
  -- Unstake
  setTime (time (date 2025 Dec 20) 0 0 0)
  returnedTokenCid <- submit alice do
    exerciseCmd stakeCid Unstake with
      currentTime = time (date 2025 Dec 20) 0 0 0
  
  return ()

-- Test: Proposal with rejection
testProposalRejection : Script ()
testProposalRejection = script do
  dao <- allocateParty "DAO"
  alice <- allocateParty "Alice"
  bob <- allocateParty "Bob"
  
  -- Setup pool (with alice and bob as observers)
  poolCid <- submit dao do
    createCmd StakingPool with
      dao = dao
      tokenSymbol = "TEST"
      totalStaked = 0.0
      stakers = [alice, bob]
  
  -- Issue and stake tokens
  aliceTokenCid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = alice
      amount = 400.0
      symbol = "TEST"
  
  bobTokenCid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = bob
      amount = 600.0
      symbol = "TEST"
  
  aliceStakeCid <- submit alice do
    exerciseCmd poolCid Stake with
      staker = alice
      tokenCid = aliceTokenCid
  
  bobStakeCid <- submit bob do
    exerciseCmd poolCid Stake with
      staker = bob
      tokenCid = bobTokenCid
  
  -- Create proposal
  proposalReqCid <- submit alice do
    createCmd ProposalRequest with
      dao = dao
      proposer = alice
      proposalId = "PROP-002"
      title = "Controversial Proposal"
      description = "This proposal will be rejected"
      payload = "custom:action"
      action = CustomAction with actionData = "controversial_action"
      quorumRequired = 100.0
      votingPeriodDays = 7
      treasuryCid = None
      eligibleVoters = [alice, bob]
  
  proposalCid <- submit dao do
    exerciseCmd proposalReqCid ApproveProposal
  
  -- Vote (Bob votes against with more power)
  proposalCid <- submit alice do
    exerciseCmd proposalCid CastVote with
      voter = alice
      stakeCid = aliceStakeCid
      inFavor = True
  
  proposalCid <- submit bob do
    exerciseCmd proposalCid CastVote with
      voter = bob
      stakeCid = bobStakeCid
      inFavor = False
  
  -- Finalize (should be rejected)
  setTime (time (date 2025 Dec 20) 0 0 0)
  proposalCid <- submit dao do
    exerciseCmd proposalCid FinalizeProposal with
      currentTime = time (date 2025 Dec 20) 0 0 0
  
  return ()

-- Test: Treasury operations
testTreasuryOperations : Script ()
testTreasuryOperations = script do
  dao <- allocateParty "DAO"
  alice <- allocateParty "Alice"
  
  -- Create treasury (with alice as observer)
  treasuryCid <- submit dao do
    createCmd Treasury with
      dao = dao
      balance = 5000.0
      tokenSymbol = "TEST"
      beneficiaries = [alice]
  
  -- Deposit to treasury
  tokenCid <- submit dao do
    createCmd GovernanceToken with
      issuer = dao
      owner = alice
      amount = 1000.0
      symbol = "TEST"
  
  treasuryCid <- submitMulti [dao, alice] [] do
    exerciseCmd treasuryCid DepositToTreasury with
      depositor = alice
      tokenCid = tokenCid
  
  -- Add beneficiary
  treasuryCid <- submit dao do
    exerciseCmd treasuryCid AddBeneficiary with
      newBeneficiary = alice
  
  return ()

-- Test: Member invitation flow
testMemberInvitation : Script ()
testMemberInvitation = script do
  dao <- allocateParty "DAO"
  newMember <- allocateParty "NewMember"
  
  -- Create admin
  adminCid <- submit dao do
    createCmd DAOAdmin with
      admin = dao
      daoName = "TestDAO"
      tokenSymbol = "TDAO"
      members = []
  
  -- Send invitation
  invitationCid <- submit dao do
    createCmd DAOMemberInvitation with
      dao = dao
      invitee = newMember
      daoName = "TestDAO"
      initialTokenAllocation = 500.0
  
  -- Accept invitation (both dao and newMember must authorize)
  tokenCid <- submitMulti [newMember, dao] [] do
    exerciseCmd invitationCid AcceptInvitation with
      adminCid = adminCid
  
  return ()

-- Run all tests
runAllTests : Script ()
runAllTests = script do
  testTokenOperations
  testStakingOperations
  testTreasuryOperations
  testMemberInvitation
  testProposalRejection
  testCompleteDAOLifecycle
  return ()
